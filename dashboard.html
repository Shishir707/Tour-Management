<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BRHL Admin — Events & T-Shirts</title>
  <link rel="shortcut icon" href="gallery/brhlLogo.jpeg" type="image/jpeg" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <!-- Firebase v8 (compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root {
      --blue-700: #004080;
      --blue-500: #0073e6;
      --muted: #6b7280;
      --card-shadow: 0 6px 20px rgba(2, 6, 23, 0.06);
      --radius: 10px;
      --accent: #007dfa;
    }

    * {
      box-sizing: border-box;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f3f6fb;
      color: #1f2937;
    }

    .page-container {
      max-width: 1100px;
      width: 95%;
      margin: 28px auto;
      background: white;
      box-shadow: var(--card-shadow);
      border-radius: var(--radius);
      overflow: hidden;
      display: none;
      min-height: 80vh;
      flex-direction: column;
    }

    header {
      background: linear-gradient(90deg, var(--blue-700), var(--blue-500));
      color: #fff;
      padding: 16px 22px;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    header img {
      height: 44px;
      border-radius: 6px;
      object-fit: cover;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.2px;
    }

    header .sub {
      font-size: 12px;
      opacity: 0.9;
      margin-left: 6px;
      color: #eef6ff;
      font-weight: 500;
    }

    main {
      padding: 18px 20px;
      flex: 1;
      overflow: auto;
    }

    footer {
      background: var(--blue-700);
      color: white;
      padding: 12px 18px;
      text-align: center;
      font-size: 13px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-bottom: 22px;
    }

    .card {
      background: linear-gradient(180deg, #fff, #fbfdff);
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
      border-left: 4px solid var(--accent);
    }

    .card h3 {
      margin: 0 0 8px 0;
      font-size: 15px;
    }

    .stat {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
    }

    .small {
      font-size: 13px;
      color: var(--muted);
    }

    section {
      margin-bottom: 28px;
    }

    section h2 {
      margin: 0 0 12px 0;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .controls button,
    button.downloadBtn {
      background: var(--blue-700);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }

    .controls button.secondary {
      background: #f0f4ff;
      color: var(--blue-700);
      border: 1px solid rgba(0, 0, 0, 0.06);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      background: white;
    }

    th,
    td {
      padding: 8px 10px;
      border: 1px solid #e8eef8;
      text-align: left;
      vertical-align: middle;
    }

    th {
      background: #fbfdff;
      color: var(--blue-700);
      font-weight: 700;
      font-size: 13px;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: #fbfcff;
    }

    td .muted {
      color: var(--muted);
      font-size: 12px;
    }
    

    .status-badge {
      padding: 6px 8px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 13px;
      display: inline-block;
      min-width: 84px;
      text-align: center;
    }

    .status-pending {
      background: #fff3f0;
      color: #c5302e;
      border: 1px solid rgba(197, 47, 47, 0.06);
    }

    .status-confirmed {
      background: #ecfdf5;
      color: #047857;
      border: 1px solid rgba(4, 120, 87, 0.06);
    }

    /* Login overlay */
    #loginOverlay {
      position: fixed;
      inset: 0;
      background: rgba(26, 38, 72, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #loginBox {
      background: linear-gradient(180deg, #f7fbff, #ecf6ff);
      padding: 28px;
      border-radius: 12px;
      width: 340px;
      box-shadow: 0 10px 40px rgba(2, 6, 23, 0.4);
      text-align: center;
    }

    #loginBox h2 {
      margin: 0 0 12px 0;
      color: var(--blue-700);
    }

    #loginBox input {
      width: 100%;
      padding: 10px 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
    }

    #loginBox button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 700;
      cursor: pointer;
    }

    #loginError {
      color: #c5302e;
      min-height: 18px;
      margin-top: 8px;
      font-size: 13px;
    }

    #logoutBtn {
      position: fixed;
      top: 14px;
      right: 14px;
      background: #cc2f2f;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 10000;
      display: none;
    }

    @media (max-width:640px) {
      header h1 {
        font-size: 16px;
      }

      table {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <!-- Login Overlay -->
  <div id="loginOverlay">
    <div id="loginBox">
      <img src="gallery/brhlLogo.jpeg" alt="BRHL"
        style="height:56px; border-radius:8px; object-fit:cover; margin-bottom:8px;">
      <h2>Admin Login</h2>
      <form id="loginForm">
        <input id="username" placeholder="Email" autocomplete="username" required />
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" required />
        <button type="submit">Login</button>
      </form>
      <div id="loginError"></div>
    </div>
  </div>

  <button id="logoutBtn">Logout</button>

  <div class="page-container" id="pageContainer">
    <header>
      <img src="gallery/brhlLogo.jpeg" alt="BRHL Logo" />
      <div>
        <div style="display:flex; align-items:center; gap:8px;">
          <h1>BRHL Admin Panel</h1>
          <div class="sub">Events & T-Shirts — Admin Dashboard</div>
        </div>
      </div>
    </header>

    <main>
      <div class="grid">
        <div class="card">
          <h3>Participants</h3>
          <div class="small">Total registered / Confirmed</div>
          <div style="margin-top:10px;">
            <div>Total: <span id="totalParticipants" class="stat">0</span></div>
            <div style="margin-top:6px;">Confirmed: <span id="confirmedParticipants" class="stat"
                style="color:#16a34a">0</span></div>
          </div>
        </div>

        <div class="card">
          <h3>T-Shirt Orders</h3>
          <div class="small">Total orders / Confirmed</div>
          <div style="margin-top:10px;">
            <div>Total: <span id="totalOrders" class="stat">0</span></div>
            <div style="margin-top:6px;">Confirmed: <span id="confirmedOrders" class="stat"
                style="color:#16a34a">0</span></div>
          </div>
        </div>

        <div class="card" style="border-left-color:#a803fa;">
          <h3>T-Shirt Size Summary</h3>
          <div id="sizeSummary" style="margin-top:8px; font-weight:700; color:#6b21a8;">Loading...</div>
          <div id="sizeDetails" style="margin-top:6px; font-size:13px; color:#333;"></div>
          <div class="small" style="margin-top:8px;">(Click size to see names)</div>
        </div>
      </div>

      <section>
        <h2>
          Event Registrations
          <div class="controls">
            <button class="secondary" id="refreshEventsBtn">Refresh</button>
            <button class="downloadBtn" id="downloadEventsPdf">Download PDF</button>
          </div>
        </h2>
        <div style="overflow:auto; max-height:360px;">
          <table id="eventTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Boarding</th>
                <th>Size</th>
                <th>Payment</th>
                <th>TrxID</th>
                <th>Collector</th>
                <th>Comment</th>
                <th>Registered</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="participantBody">
              <tr>
                <td colspan="11" class="muted" style="text-align:center;">Loading event registrations…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section>
        <h2>
          T-Shirt Orders
          <div class="controls">
            <button class="secondary" id="refreshOrdersBtn">Refresh</button>
            <button class="downloadBtn" id="downloadOrdersPdf">Download PDF</button>
          </div>
        </h2>
        <div style="overflow:auto; max-height:360px;">
          <table id="orderTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Phone</th>
                <th>Hometown</th>
                <th>Size</th>
                <th>Payment</th>
                <th>TrxID</th>
                <th>Collector</th>
                <th>Comment</th>
                <th>Registered</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="orderTableBody">
              <tr>
                <td colspan="11" class="muted" style="text-align:center;">Loading t-shirt orders…</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <footer>
      © 2025 BRHL | All Rights Reserved — Developed by BRHL Team — <a href="tel:+8801611802209"
        style="color: #fff; text-decoration: underline;">Contact Us</a>
    </footer>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbxXISUM_HJZ-iLuQ6uby9KBqFc7seBIg",
      authDomain: "brhl-665de.firebaseapp.com",
      databaseURL: "https://brhl-665de-default-rtdb.firebaseio.com",
      projectId: "brhl-665de",
      storageBucket: "brhl-665de.appspot.com",
      messagingSenderId: "907817820790",
      appId: "1:907817820790:web:14b70e8295fdcff64f7557",
      measurementId: "G-D3GJ6P2DE4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const loginOverlay = document.getElementById('loginOverlay');
    const loginForm = document.getElementById('loginForm');
    const loginError = document.getElementById('loginError');
    const pageContainer = document.getElementById('pageContainer');
    const logoutBtn = document.getElementById('logoutBtn');

    const participantBody = document.getElementById('participantBody');
    const orderTableBody = document.getElementById('orderTableBody');
    const totalParticipantsEl = document.getElementById('totalParticipants');
    const confirmedParticipantsEl = document.getElementById('confirmedParticipants');
    const totalOrdersEl = document.getElementById('totalOrders');
    const confirmedOrdersEl = document.getElementById('confirmedOrders');
    const sizeSummaryEl = document.getElementById('sizeSummary');
    const sizeDetailsEl = document.getElementById('sizeDetails');

    function showDashboard() {
      loginOverlay.style.display = 'none';
      pageContainer.style.display = 'flex';
      logoutBtn.style.display = 'block';
    }

    function hideDashboard() {
      loginOverlay.style.display = 'flex';
      pageContainer.style.display = 'none';
      logoutBtn.style.display = 'none';
    }

    loginForm.addEventListener('submit', async e => {
      e.preventDefault();
      loginError.textContent = '';
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      try {
        const credSnap = await db.ref('loginCredentials').once('value');
        const cred = credSnap.val();
        if (cred && cred.adminEmail === username && cred.adminPassword === password) {
          showDashboard();
          loadDashboard();
          Swal.fire({ icon: 'success', title: 'Login successful', timer: 1200, showConfirmButton: false });
        } else {
          loginError.textContent = 'Invalid username or password.';
        }
      } catch (err) {
        loginError.textContent = 'Error connecting to database.';
      }
    });

    logoutBtn.addEventListener('click', () => {
      hideDashboard();
      setTimeout(() => location.reload(), 200);
    });

    function fmtTime(ts) {
      if (!ts) return '';
      const d = new Date(ts);
      if (isNaN(d)) return ts;
      return d.toLocaleString();
    }

    function changeStatus(id) {
      const confirmNative = confirm("You are about to update the participant's status. Click OK to proceed.");

      if (!confirmNative) return;

      const ref = db.ref(`eventRegistrations/${id}`);
      ref.once('value').then(snapshot => {
        const data = snapshot.val();
        if (!data) return;

        const newStatus = data.status === 'Confirmed' ? 'Pending' : 'Confirmed';
        ref.update({ status: newStatus }).then(() => {
          loadEvents().then(updateCombinedSizeSummary);

          Swal.fire({
            icon: 'success',
            title: 'Updated!',
            text: `Participant status updated successfully to ${newStatus}.`,
            timer: 1500,
            showConfirmButton: false
          });
        });
      });
    }


    function updateOrderStatus(id) {
      const confirmNative = confirm("You are about to update the order status. Click OK to proceed.");

      if (!confirmNative) return;

      const ref = db.ref(`tshirtOrders/${id}`);
      ref.once('value').then(snapshot => {
        const data = snapshot.val();
        if (!data) return;

        const newStatus = data.status === 'Confirmed' ? 'Pending' : 'Confirmed';
        ref.update({ status: newStatus }).then(() => {
          loadOrders().then(updateCombinedSizeSummary);
          Swal.fire({
            icon: 'success',
            title: 'Updated!',
            text: `Order status updated successfully to ${newStatus}.`,
            timer: 1500,
            showConfirmButton: false
          });
        });
      });
    }



    async function loadEvents() {
      const snapshot = await db.ref('eventRegistrations').once('value');
      const data = snapshot.val();
      participantBody.innerHTML = '';
      let total = 0, confirmed = 0;
      if (data) {
        Object.entries(data).forEach(([id, p]) => {
          total++;
          if (p.status === 'Confirmed') confirmed++;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${p.name}</td>
            <td>${p.phone}</td>
            <td>${p.boardingPoint}</td>
            <td>${p.tshirtSize || ''}</td>
            <td>${p.paymentMethod}</td>
            <td>${p.transactionID}</td>
            <td>${p.collector}</td>
            <td>${p.comment || ''}</td>
            <td>${fmtTime(p.timestamp)}</td>
            <td><span class="status-badge status-${p.status.toLowerCase()}">${p.status}</span></td>
            <td><button onclick="changeStatus('${id}')">Confirm</button></td>`;
          participantBody.appendChild(tr);
        });
      } else {
        participantBody.innerHTML = `<tr><td colspan="11" class="muted" style="text-align:center;">No registrations yet.</td></tr>`;
      }
      totalParticipantsEl.textContent = total;
      confirmedParticipantsEl.textContent = confirmed;
    }

    async function loadOrders() {
      const snapshot = await db.ref('tshirtOrders').once('value');
      const data = snapshot.val();
      orderTableBody.innerHTML = '';
      let total = 0, confirmed = 0;
      if (data) {
        Object.entries(data).forEach(([id, o]) => {
          total++;
          if (o.status === 'Confirmed') confirmed++;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${o.name}</td>
            <td>${o.phone}</td>
            <td>${o.homeStation}</td>
            <td>${o.tshirtSize || ''}</td>
            <td>${o.paymentMethod}</td>
            <td>${o.timestamp}</td>
            <td>${o.collector}</td>
            <td>${o.comment || ''}</td>
            <td>${fmtTime(o.timestamp)}</td>
            <td><span class="status-badge status-${o.status.toLowerCase()}">${o.status}</span></td>
            <td><button onclick="updateOrderStatus('${id}')">Confirm</button></td>`;
          orderTableBody.appendChild(tr);
        });
      } else {
        orderTableBody.innerHTML = `<tr><td colspan="11" class="muted" style="text-align:center;">No orders yet.</td></tr>`;
      }
      totalOrdersEl.textContent = total;
      confirmedOrdersEl.textContent = confirmed;
    }

    async function updateCombinedSizeSummary() {
      const sizeCount = {};
      const sizeNames = {};

      // Event Registrations
      const eventSnap = await db.ref('eventRegistrations').once('value');
      const events = eventSnap.val();
      if (events) {
        Object.values(events).forEach(p => {
          if (p.status === 'Confirmed' && p.tshirtSize) {
            const sz = p.tshirtSize.toUpperCase();
            sizeCount[sz] = (sizeCount[sz] || 0) + 1;
            if (!sizeNames[sz]) sizeNames[sz] = [];
            sizeNames[sz].push(p.name);
          }
        });
      }

      // T-Shirt Orders
      const orderSnap = await db.ref('tshirtOrders').once('value');
      const orders = orderSnap.val();
      if (orders) {
        Object.values(orders).forEach(o => {
          if (o.status === 'Confirmed' && o.tshirtSize) {
            const sz = o.tshirtSize.toUpperCase();
            sizeCount[sz] = (sizeCount[sz] || 0) + 1;
            if (!sizeNames[sz]) sizeNames[sz] = [];
            sizeNames[sz].push(o.name);
          }
        });
      }

      sizeSummaryEl.innerHTML = '';
      sizeDetailsEl.textContent = '';
      if (Object.keys(sizeCount).length === 0) {
        sizeSummaryEl.textContent = 'No confirmed orders yet';
      } else {
        Object.entries(sizeCount).forEach(([sz, count]) => {
          const span = document.createElement('span');
          span.textContent = `${sz}: ${count}`;
          span.style.cursor = 'pointer';
          span.style.marginRight = '8px';
          span.style.fontWeight = 'bold';
          span.onclick = () => sizeDetailsEl.textContent = sizeNames[sz].join(' | ');
          sizeSummaryEl.appendChild(span);
        });
      }
    }

    async function loadDashboard() {
      await loadEvents();
      await loadOrders();
      await updateCombinedSizeSummary();
    }

    function downloadTablePDF(tableId, titleText) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'pt', 'a4'); // portrait, points, A4 size

      // Add title
      doc.setFontSize(16);
      doc.setTextColor(0, 51, 102);
      doc.text(titleText, 40, 40);

      // Grab table
      const table = document.getElementById(tableId);
      if (!table) return;

      // Extract headers
      const headers = [];
      table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent.trim());
      });

      // Extract data rows
      const data = [];
      table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => row.push(td.textContent.trim()));
        data.push(row);
      });

      // Add table using autoTable
      doc.autoTable({
        head: [headers],
        body: data,
        startY: 60,
        theme: 'grid',
        headStyles: { fillColor: [0, 76, 153], textColor: 255, fontStyle: 'bold' },
        bodyStyles: { fontSize: 10 },
        styles: { cellPadding: 4 },
        margin: { left: 20, right: 20 },
        tableWidth: 'auto',
      });

      doc.save(`${titleText.replace(/\s/g, '_')}.pdf`);
    }

    // Add button events
    document.getElementById('downloadEventsPdf').addEventListener('click', () => {
      downloadTablePDF('eventTable', 'BRHL Event Registrations');
    });

    document.getElementById('downloadOrdersPdf').addEventListener('click', () => {
      downloadTablePDF('orderTable', 'BRHL T-Shirt Orders');
    });

    // Refresh button functionality
    document.getElementById('refreshEventsBtn').addEventListener('click', async () => {
      try {
        // Optional: show a small loading message
        const participantBody = document.getElementById('participantBody');
        participantBody.innerHTML = `<tr><td colspan="11" class="muted" style="text-align:center;">Refreshing…</td></tr>`;

        // Call the function to load event data
        await loadEvents();

        // Optional: update combined T-shirt summary as well
        await updateCombinedSizeSummary();
      } catch (err) {
        console.error('Error refreshing events:', err);
        Swal.fire({
          icon: 'error',
          title: 'Failed to refresh data',
          text: err.message
        });
      }
    });

    // Refresh T-Shirt Orders
    document.getElementById('refreshOrdersBtn').addEventListener('click', async () => {
      try {
        // Show temporary loading message
        const orderTableBody = document.getElementById('orderTableBody');
        orderTableBody.innerHTML = `<tr><td colspan="11" class="muted" style="text-align:center;">Refreshing…</td></tr>`;

        // Load T-shirt orders
        await loadOrders();

        // Update combined T-shirt size summary
        await updateCombinedSizeSummary();
      } catch (err) {
        console.error('Error refreshing orders:', err);
        Swal.fire({
          icon: 'error',
          title: 'Failed to refresh T-Shirt orders',
          text: err.message
        });
      }
    });




    document.getElementById('refreshEventsBtn').addEventListener('click', () => loadDashboard());
    document.getElementById('refreshOrdersBtn').addEventListener('click', () => loadDashboard());
  </script>
</body>

</html>